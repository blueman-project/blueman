# coding=utf-8
from __future__ import print_function
from __future__ import division
from __future__ import absolute_import
from __future__ import unicode_literals

import dbus.service
import os
import subprocess
import signal
from blueman.plugins.MechanismPlugin import MechanismPlugin


class Rfcomm(MechanismPlugin):
    files = {}

    @dbus.service.method('org.blueman.Mechanism', in_signature="d")
    def open_rfcomm(self, port_id):
        subprocess.Popen(['@LIBEXECDIR@/blueman-rfcomm-watcher', '/dev/rfcomm%d' % port_id])

    @dbus.service.method('org.blueman.Mechanism', in_signature="d")
    def close_rfcomm(self, port_id):
        command = 'blueman-rfcomm-watcher /dev/rfcomm%d' % port_id

        out, err = subprocess.Popen(['pgrep', '-f', command], stdout=subprocess.PIPE).communicate()
        try:
            pid = int(out.decode("UTF-8").strip())
            os.kill(pid, signal.SIGTERM)
        except ValueError:
            pass
