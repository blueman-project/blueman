on:
  push:
    tags:
      - "*"

jobs:
  release:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v2
      - run: echo "::set-output name=VERSION::${GITHUB_REF#refs/tags/}"
        id: version
      - run: |
          notes="$(sed --quiet '/^## ${{ steps.version.outputs.VERSION }}/,/^## /{/^## /b;p}' CHANGELOG.md)"
          notes="${notes//'%'/'%25'}"
          notes="${notes//$'\n'/'%0A'}"
          notes="${notes//$'\r'/'%0D'}"
          echo ::set-output name=NOTES::$notes
        id: notes
      - run: sudo apt-get update
      - run: sudo apt-get install -y -qq --no-install-recommends cmake cython3 gcc jq libbluetooth-dev libc6-dev libglib2.0-dev meson python3-dev python-gi-dev xz-utils
      - run: meson --warnlevel 3 --buildtype release -Druntime_deps_check=false build
      - run: if [[ $(meson introspect --projectinfo build | jq -r .version) != ${{ steps.version.outputs.VERSION }} ]]; then echo "Did not find expected version in configure.ac"; exit 1; fi
      - run: ./make_release.sh
      - uses: softprops/action-gh-release@v1
        with:
          draft: true
          body: ${{ steps.notes.outputs.NOTES }}
          files: |
            blueman-${{ steps.version.outputs.VERSION }}.tar.xz
            blueman-${{ steps.version.outputs.VERSION }}.tar.gz
