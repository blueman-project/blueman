#!@PYTHON@
import os
import sys
import logging
import gettext


resource_file = "@pkgdatadir@/blueman.gresource"
settings_path = "@pkgdatadir@/settings.json"
src_paths = {}

# support running uninstalled
_dirname = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
if 'BLUEMAN_SOURCE' in os.environ:
    sys.path = [_dirname, os.path.join(_dirname, 'module', '.libs')] + sys.path
    os.environ["GSETTINGS_SCHEMA_DIR"] = os.path.join(_dirname, "data")
    resource_file = os.path.join(_dirname, "data", "blueman.gresource")
    settings_path = os.path.join(_dirname, "data", "configs", "settings.json")
    src_paths.update({
        "bindir": os.path.join(_dirname, "apps"),
        "rfcomm_watcher_path": os.path.join(_dirname, "apps")
    })

gettext.textdomain("@GETTEXT_PACKAGE@")

from blueman.Functions import create_parser, create_logger, set_proc_title, load_json
from blueman.config.Settings import BluemanSettings
from blueman.main.Adapter import BluemanAdapters

settings = load_json(settings_path, src_paths)
bm_settings = BluemanSettings(**settings)

if __name__ == '__main__':
    parser = create_parser()
    parser.add_argument("--socket-id", dest="socket_id", action="store", type=int, metavar="ID")
    parser.add_argument("adapter", nargs="?", metavar="ADAPTER NAME")
    args = parser.parse_args()

    if args.LEVEL.upper() == "DEBUG":
        log_level = logging.DEBUG
    elif args.LEVEL.upper() == "INFO":
        log_level = logging.INFO
    elif args.LEVEL.upper() == "WARNING":
        log_level = logging.WARNING
    elif args.LEVEL.upper() == "ERROR":
        log_level = logging.ERROR
    elif args.LEVEL.upper() == "CRITICAL":
        log_level = logging.CRITICAL
    else:
        log_level = logging.WARNING

    create_logger(log_level, "blueman-adapters", syslog=args.syslog)

    set_proc_title()

    app = blueman_adapters = BluemanAdapters(args.adapter, args.socket_id, resource_file, bm_settings)

    app.run()
